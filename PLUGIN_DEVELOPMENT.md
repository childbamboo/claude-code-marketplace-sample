# プラグイン開発ガイドライン

このドキュメントは、Claude Bootstrap Kit (CBK) マーケットプレイスにおけるプラグイン開発の設計方針とベストプラクティスをまとめたものです。SuperClaude Frameworkの設計哲学を参考にしています。

## 目次

- [核となる設計原則](#核となる設計原則)
- [コマンド設計パターン](#コマンド設計パターン)
- [エージェント設計パターン](#エージェント設計パターン)
- [ディレクトリ構造](#ディレクトリ構造)
- [命名規約](#命名規約)
- [パフォーマンス要件](#パフォーマンス要件)
- [ドキュメント要件](#ドキュメント要件)
- [品質基準](#品質基準)

---

## 核となる設計原則

### 1. 行動的レイヤー分離（Behavioral Layer Separation）

プラグインは**動作パターンを定義**することで、Claudeの認知プロセスを変更します。コード変更ではなく、指示の注入により機能を実現します。

**原則:**
- コマンドはプロンプトによって動作を定義する
- エージェントはペルソナと専門知識を持つ
- 実装の詳細ではなく、期待する振る舞いを記述する

### 2. コンテキスト効率（Context Efficiency）

プラグインのフットプリントを最小化し、ユーザーコードに最大限のトークンを割り当てます。

**原則:**
- **簡潔なプロンプト**: 冗長な説明を避け、必要最小限の指示に絞る
- **段階的な情報開示**: 必要な時に必要な情報だけをロードする
- **コンテキスト共有**: 重複する情報は共通コンポーネントに集約する

**目標:**
- コマンドプロンプト: 500トークン以内を推奨
- エージェントプロンプト: 1500トークン以内を推奨

### 3. ドメイン専門性（Domain Expertise）

汎用的なアシスタントではなく、**特定のドメインに特化した専門家**として設計します。

**原則:**
- 明確な責任範囲を定義する
- 専門知識と固有の視点を持つ
- 他のコンポーネントと協調して動作する

### 4. 段階的な複雑性（Progressive Complexity）

シンプルな使用から高度な使用まで、段階的に対応します。

**原則:**
- デフォルトは最もシンプルな動作
- オプションで高度な機能を提供
- 学習曲線を緩やかにする

### 5. ドキュメント駆動開発（Documentation-Driven Development）

ドキュメントは単なる説明ではなく、**実行可能な制約**として機能します。

**原則:**
- 設計前にドキュメントを書く
- ドキュメントを常に最新に保つ
- ドキュメントから動作が明確に理解できる

---

## コマンド設計パターン

カスタムスラッシュコマンドは、特定のワークフローを自動化するための入り口です。

### カスタムメタデータフィールド

SuperClaude Frameworkに倣い、以下のカスタムメタデータフィールドを使用できます。これらは**Claude Code標準仕様ではありません**が、ドキュメント目的および将来的なツール活用のために使用します。

**利用可能なカスタムフィールド:**
- `category`: コマンドの分類（workflow, development, analysis など）
- `complexity`: 複雑度（simple, standard, advanced, expert）
- `required-agents`: 使用するエージェントのリスト
- `mcp-servers`: 必要なMCPサーバーのリスト
- `persona`: アクティブ化するペルソナ（エージェント用）

**注意:** これらのフィールドはClaude Codeに無視されますが、YAMLとして構造化されているため、将来的にスクリプトでパース可能です。実際のエージェント起動は**プロンプト本文**で明示的に記述してください。

### コマンド構造テンプレート

```markdown
---
description: コマンドの簡潔な説明（60文字以内）
category: workflow  # workflow, development, analysis, maintenance など
complexity: standard  # simple, standard, advanced, expert
required-agents: [agent-name]  # 使用するエージェントのリスト
mcp-servers: [serena]  # 必要なMCPサーバー
---

# /command-name - コマンドタイトル

## 核となる機能

このコマンドが何をするのか、2-3文で明確に説明します。

## コマンド構文

\`\`\`
/command-name [required-arg] [--option1] [--option2]
\`\`\`

**引数:**
- `required-arg`: 必須引数の説明

**オプション:**
- `--option1`: オプション1の説明
- `--option2`: オプション2の説明

## トリガーシナリオ

このコマンドをいつ使用すべきかを明確にします。

### 必須トリガー
- 必ず実行すべき状況

### 推奨トリガー
- 実行を強く推奨する状況

### プロアクティブトリガー
- 先を見据えた実行が有効な状況

## 実行フロー

コマンドの実行ステップを段階的に説明します。各フェーズには明確な名前と目的を付けます。

**重要:** `required-agents`に指定したエージェントを起動する場合は、プロンプト本文内でTaskツールの使用を明示的に記述してください。

### 1. **フェーズ名**: 目的
- 具体的なアクション
- 実行内容
- エージェント起動の場合: Use the Task tool with subagent_type='agent-name' to...

### 2. **フェーズ名**: 目的
- 具体的なアクション
- 実行内容

## パフォーマンス要件

- **操作1**: <目標時間
- **操作2**: <目標時間
- **全体目標**: <目標時間

## 主要機能

- **機能1**: 説明
- **機能2**: 説明

## 動作境界

**コマンドが実行すること:**
- 明確に実行する範囲

**コマンドが実行しないこと:**
- 明確に実行しない範囲

## 統合要件

**必須ツール:**
- 使用するMCPサーバーやツール
- 必要な外部依存関係

## 使用例

\`\`\`bash
# 基本的な使用例
/command-name arg1

# オプション付き
/command-name arg1 --option1
\`\`\`

## 成功基準

- ✓ 検証可能な成功条件1
- ✓ 検証可能な成功条件2
```

### コマンド設計のベストプラクティス

1. **単一責任の原則**: 1つのコマンドは1つの明確な目的を持つ
2. **冪等性**: 同じ入力で何度実行しても安全
3. **フェイルセーフ**: エラー時の明確な動作を定義
4. **ユーザー確認**: 破壊的な操作の前に必ず確認を求める
5. **進捗可視化**: 長時間実行の場合は進捗を示す

---

## エージェント設計パターン

サブエージェントは、特定のドメインに特化した専門家として動作します。

### エージェント構造テンプレート

```markdown
---
description: エージェントの簡潔な説明（60文字以内）
tools: [Read, Write, Edit, Grep, Glob, Bash]  # 使用可能なツール（Claude Code標準）
model: sonnet  # 使用モデル（sonnet/opus/haiku）（Claude Code標準）
category: specialist  # specialist, architect, analyst など
complexity: standard  # simple, standard, advanced, expert
persona: domain-expert  # このエージェントのペルソナ識別子
mcp-servers: [serena]  # 必要なMCPサーバー
---

# [Role] - エージェント名

## ペルソナ

あなたは[専門分野]の専門家です。[具体的な専門性と視点を2-3文で説明]

## 核となる責任

このエージェントの主要な責任範囲を明確に定義します。

1. **責任1**: 詳細な説明
2. **責任2**: 詳細な説明
3. **責任3**: 詳細な説明

## 専門知識領域

- **領域1**: 具体的な知識とアプローチ
- **領域2**: 具体的な知識とアプローチ
- **領域3**: 具体的な知識とアプローチ

## 実行アプローチ

### フェーズ1: 分析
- 実行する内容
- 使用するツールと方法

### フェーズ2: 計画
- 実行する内容
- 使用するツールと方法

### フェーズ3: 実行
- 実行する内容
- 使用するツールと方法

### フェーズ4: 検証
- 実行する内容
- 使用するツールと方法

## 品質基準

エージェントが出力する成果物の品質基準を定義します。

- **基準1**: 具体的なメトリクスまたは検証方法
- **基準2**: 具体的なメトリクスまたは検証方法

## 協調パターン

他のエージェントやコマンドとの連携方法を定義します。

- **連携先1**: 連携のタイミングと方法
- **連携先2**: 連携のタイミングと方法

## 制約と境界

**実行すること:**
- 明確な責任範囲

**実行しないこと:**
- 他のエージェントの責任範囲
- 明確な制約

## 出力形式

エージェントの出力形式を明確に定義します。

\`\`\`
期待される出力の構造とフォーマット
\`\`\`
```

### エージェント設計のベストプラクティス

1. **明確なペルソナ**: 専門家としての視点と価値観を持つ
2. **責任の分離**: 他のエージェントと重複しない明確な役割
3. **暗黙的な協調**: 必要に応じて他のエージェントを自然に呼び出す
4. **コンテキスト保持**: 会話を通じて学習と適応を行う
5. **品質への執着**: ドメイン専門家として高い品質基準を持つ

---

## ディレクトリ構造

### プラグイン構造

```
plugins/
└── {plugin_name}/           # プラグイン名
    ├── .claude-plugin/
    │   └── plugin.json      # プラグインマニフェスト（必須）
    ├── commands/            # カスタムスラッシュコマンド（オプション）
    │   ├── command1.md
    │   └── command2.md
    ├── agents/              # サブエージェント（オプション）
    │   ├── agent1.md
    │   └── agent2.md
    ├── skills/              # スキル（オプション）
    │   └── skill1.md
    └── README.md            # プラグイン説明（推奨）
```

### plugin.json 構造

```json
{
  "name": "plugin-name",
  "version": "1.0.0",
  "description": "プラグインの説明",
  "author": "作成者名",
  "repository": "https://github.com/user/repo",
  "license": "MIT",
  "dependencies": {
    "mcpServers": ["serena"]
  }
}
```

---

## 命名規約

### コマンド名

- **形式**: kebab-case（例: `onboarding`, `create-api`, `audit-security`）
- **プレフィックス**: プラグイン固有のプレフィックスを使用可能（例: `/backend:create-api`）
- **原則**:
  - 動詞から始める（create, update, delete, audit など）
  - 簡潔で意味が明確
  - 最大3語以内を推奨

### エージェント名

- **形式**: kebab-case（例: `backend-api-builder`, `security-auditor`）
- **パターン**: `[domain]-[role]`
- **原則**:
  - ドメインと役割を明確に表現
  - 専門性が伝わる名前
  - 最大4語以内を推奨

### ファイル名

- **コマンド**: `command-name.md`
- **エージェント**: `agent-name.md`
- **すべて小文字のkebab-case**

---

## パフォーマンス要件

効率的な実行を確保するため、以下のパフォーマンス目標を設定します。

### 目標値

| 操作タイプ | 目標時間 | 備考 |
|-----------|---------|------|
| ファイル検出・検索 | <100ms | Glob/Grep操作 |
| 軽量な分析 | <2秒 | 単一ファイルの分析 |
| コンテンツ生成 | <3秒 | ドキュメント生成など |
| MCPサーバー呼び出し | <500ms | 初期化を除く |
| コア操作全体 | <10秒 | ユーザーインタラクションを除く |

### 最適化ガイドライン

1. **並列実行**: 独立した操作は並列で実行
2. **遅延ロード**: 必要になるまで重い操作を遅延
3. **キャッシング**: 繰り返し使用する情報をキャッシュ
4. **段階的表示**: 長時間操作は進捗を段階的に表示

---

## ドキュメント要件

### 必須ドキュメント

各プラグインには以下のドキュメントが必要です：

1. **plugin.json**: プラグインマニフェスト
2. **README.md**: プラグイン概要、インストール方法、使用例
3. **コマンド/エージェントファイル**: 各コンポーネントの詳細仕様

### README.md テンプレート

```markdown
# プラグイン名

## 概要

プラグインの目的と主要機能を2-3文で説明します。

## 提供機能

### コマンド

- `/command1`: 説明
- `/command2`: 説明

### エージェント

- `agent1`: 説明
- `agent2`: 説明

## インストール

\`\`\`bash
# インストール手順
\`\`\`

## 使用例

\`\`\`bash
# 基本的な使用例
\`\`\`

## 依存関係

- MCPサーバー: serena, filesystem など
- 外部ツール: 必要に応じて

## ライセンス

MIT
```

---

## 品質基準

### コードレビューチェックリスト

プラグインをマーケットプレイスに追加する前に、以下を確認してください：

#### 構造
- [ ] 正しいディレクトリ構造に従っている
- [ ] plugin.jsonが正しく構成されている
- [ ] すべてのファイルがUTF-8エンコーディングである

#### ドキュメント
- [ ] YAMLフロントマターが正しく記述されている
- [ ] descriptionが60文字以内で明確
- [ ] 実行フローが段階的に説明されている
- [ ] トリガーシナリオが明確に定義されている
- [ ] 動作境界（実行すること/しないこと）が明記されている

#### 設計
- [ ] 単一責任の原則に従っている
- [ ] 他のコンポーネントと責任が重複していない
- [ ] パフォーマンス要件が定義されている
- [ ] エラーハンドリングが考慮されている

#### ユーザビリティ
- [ ] 使用例が具体的で実行可能
- [ ] 成功基準が明確で検証可能
- [ ] エラーメッセージが理解しやすい

#### セキュリティ
- [ ] 破壊的操作の前にユーザー確認がある
- [ ] 機密情報のハンドリングが適切
- [ ] 入力バリデーションが実装されている

### テストガイドライン

1. **手動テスト**: 各コマンド/エージェントを実際に実行して動作確認
2. **エッジケース**: 異常系や境界条件での動作確認
3. **統合テスト**: 他のコンポーネントとの連携確認
4. **パフォーマンステスト**: 目標時間内に完了することを確認

---

## マーケットプレイスへの登録

新しいプラグインを作成したら、以下の手順でマーケットプレイスに登録します：

1. **プラグインディレクトリの作成**
   ```bash
   mkdir -p plugins/{plugin_name}/.claude-plugin
   ```

2. **plugin.jsonの作成**
   上記のテンプレートを参考に作成

3. **コマンド/エージェントの作成**
   このガイドラインに従って作成

4. **marketplace.jsonへの登録**
   `.claude-plugin/marketplace.json`の`plugins`配列に追加：
   ```json
   {
     "name": "your-plugin-name",
     "source": "./plugins/{plugin_name}",
     "description": "プラグインの説明",
     "author": {
       "name": "あなたの名前"
     },
     "version": "1.0.0"
   }
   ```

5. **プルリクエストの作成**
   変更をコミットしてプルリクエストを作成

---

## 参考資料

### 推奨される学習リソース

- [SuperClaude Framework](https://github.com/SuperClaude-Org/SuperClaude_Framework) - 設計哲学の参考元
- [Claude Code Documentation](https://docs.claude.com) - 公式ドキュメント
- 既存のプラグイン実装を確認して学ぶ

### 内部ドキュメント

- `CLAUDE.md`: プロジェクト全体のコンテキスト
- `README.md`: リポジトリの概要
- `.claude-plugin/marketplace.json`: プラグイン一覧

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2025-12-09 | 1.1.0 | カスタムメタデータフィールドのセクション追加、テンプレートにcategory/complexity/required-agents/mcp-servers/personaフィールドを追加 |
| 2025-12-09 | 1.0.0 | 初版作成 |

---

## 貢献

このガイドラインへの改善提案は歓迎します。プルリクエストまたはIssueで提案してください。
